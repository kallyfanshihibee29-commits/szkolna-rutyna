<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Motywator</title>
  <style>
    :root{
      /* autumn theme */
      --bg:#FCE8D1;          /* requested background */
      --accent:#A76C2B;      /* main button color (brownish) */
      --accent-2:#E89A53;    /* lighter orange accent */
      --accent-3:#F39C12;    /* stronger orange for highlights */
      --card:#FFFFFF;
      --text:#2b2b2b;
      --muted:#6b5a50;
      --radius:14px;
      --header-h:64px;
      --bottom-h:96px;
      --btn-press-scale:0.92;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial, "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#fde7c8);color:var(--text);-webkit-font-smoothing:antialiased}
    .app{max-width:980px;margin:0 auto;padding:12px;min-height:100vh;position:relative;padding-bottom:calc(var(--bottom-h) + 18px)}
    header{height:var(--header-h);display:flex;align-items:center;gap:12px;padding:12px}
    .logo{display:flex;align-items:center;gap:10px}
    .coin-logo{
      width:52px;height:52px;border-radius:12px;
      background:linear-gradient(145deg,var(--accent-2),var(--accent));
      display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;
      box-shadow:0 18px 48px rgba(167,108,43,0.18);font-size:22px
    }
    h1{font-size:18px;margin:0}
    .wallet{display:flex;align-items:center;gap:12px;margin-left:auto}
    .wallet-coin{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;background:linear-gradient(145deg,#ffd66b,#f5b800);box-shadow:0 10px 28px rgba(0,0,0,0.08);font-weight:900;font-size:18px}

    .content-viewport{position:relative;overflow:hidden;border-radius:var(--radius);max-width:980px;margin:0 auto}
    .content-wrapper{display:flex;transform:translate3d(0,0,0);touch-action:pan-y}
    .page{flex:0 0 100%;height:calc(100vh - var(--header-h) - var(--bottom-h) - 24px);overflow:auto;padding:12px}
    .panel{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 16px 60px rgba(0,0,0,0.06);min-height:100%;transition:box-shadow .2s}

    .muted{color:var(--muted)}
    .btn{
      background:linear-gradient(180deg,var(--accent-2),var(--accent));
      border:0;color:#fff;padding:12px 16px;border-radius:14px;cursor:pointer;font-weight:900;
      box-shadow:0 22px 72px rgba(167,108,43,0.16);
      transition:transform .18s cubic-bezier(.2,.9,.2,1),box-shadow .18s,opacity .12s,filter .18s;
      position:relative;overflow:hidden;will-change:transform,box-shadow,filter;
    }
    .btn:hover{ transform:translateY(-8px) scale(1.03); box-shadow:0 40px 120px rgba(167,108,43,0.22); filter:brightness(1.04) }
    .btn:active{ transform:scale(var(--btn-press-scale)); box-shadow:0 12px 34px rgba(0,0,0,0.12); }
    .btn.small{padding:8px 10px;border-radius:12px;font-size:14px}
    .btn.secondary{background:#fff;color:var(--text);border:1px solid rgba(0,0,0,0.06); box-shadow:none}

    .click-pulse{touch-action:none}
    .clickable-card{cursor:pointer}

    /* checkbox: use accent-color so check mark is brown on modern browsers */
    input[type="checkbox"]{
      width:20px;height:20px; accent-color:var(--accent); cursor:pointer;
      -webkit-appearance:checkbox; appearance:checkbox;
      transition:transform .18s ease, box-shadow .18s ease;
    }
    input[type="checkbox"]:active{ transform:scale(0.92); }

    /* stronger task animations */
    .enter-pop{animation:popIn .36s cubic-bezier(.2,.9,.2,1) both}
    @keyframes popIn{from{transform:translateY(18px) scale(.96);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}

    .task{
      display:flex;align-items:center;gap:12px;padding:14px;border-radius:14px;border:1px solid rgba(0,0,0,0.06);
      background:#fff;transition:transform .28s cubic-bezier(.2,.9,.2,1),box-shadow .28s,opacity .28s;
      will-change:transform,opacity,box-shadow;
    }
    .task:hover{transform:translateY(-12px) scale(1.02);box-shadow:0 40px 120px rgba(0,0,0,0.12)}
    /* completed animation - more intensive */
    .task.completed{
      border-left:6px solid var(--accent-3); background:linear-gradient(90deg,rgba(243,156,18,0.06),#fff);
      animation:completeMove .42s cubic-bezier(.2,.9,.2,1) both;
      transform-origin:left center;
    }
    @keyframes completeMove{
      0%{ transform:translateY(0) scale(1); opacity:1; }
      40%{ transform:translateY(6px) scale(.995) rotate(-0.2deg); opacity:.98; }
      100%{ transform:translateY(0) scale(1); opacity:0.98; }
    }
    /* emphasize checkbox check mark size on checked tasks */
    .task input[type="checkbox"]{ width:20px;height:20px; }

    .task .meta b{ display:block; transition:color .18s, text-decoration .18s; }
    .task.completed .meta b{ color: #6a4a36; text-decoration:line-through; opacity:0.95; }

    .quick-grid .card{transition:transform .14s,box-shadow .14s;display:flex;flex-direction:column;justify-content:space-between;padding:14px;border-radius:14px;border:1px solid rgba(0,0,0,0.04);background:linear-gradient(180deg,#fff,#fff7ee)}
    .quick-grid .card:hover{transform:translateY(-10px);box-shadow:0 38px 88px rgba(0,0,0,0.10)}

    /* bottom nav with enhanced shadow / halo behind it */
    .bottom-nav{
      position:fixed;left:50%;transform:translateX(-50%);bottom:12px;height:var(--bottom-h);
      display:flex;align-items:center;gap:12px;padding:18px 22px;border-radius:999px;
      background:linear-gradient(180deg,rgba(255,255,255,0.98),#fff);
      box-shadow:0 48px 140px rgba(0,0,0,0.22);z-index:300;touch-action:none;backdrop-filter:blur(8px);
      max-width:980px;width:calc(100% - 40px);user-select:none; isolation:isolate;
      transition:transform .18s, box-shadow .18s;
    }
    .bottom-nav:hover{ transform:translateY(-4px); box-shadow:0 60px 180px rgba(0,0,0,0.26); }

    /* extra soft blurred shadow / halo behind the pill */
    .bottom-nav::after{
      content:'';
      position:absolute;
      left:8px;
      right:8px;
      top:100%;
      height:36px;
      border-radius:999px;
      background: radial-gradient(ellipse at center, rgba(167,108,43,0.18), rgba(0,0,0,0.06));
      filter: blur(22px);
      z-index:-1;
      pointer-events:none;
      transform:translateY(8px);
      opacity:1;
    }
    .bottom-nav::before{
      content:'';
      position:absolute;
      left:0;
      right:0;
      top:100%;
      height:10px;
      border-radius:999px;
      background:linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.02));
      filter: blur(8px);
      z-index:-1;
      pointer-events:none;
      transform:translateY(3px);
    }

    .nav-btn{
      flex:1;display:flex;align-items:center;gap:10px;padding:12px 18px;border-radius:999px;background:transparent;border:0;cursor:pointer;font-weight:800;color:var(--muted);transition:all .14s;justify-content:center;
      min-width:86px;max-width:240px;
    }
    .nav-btn .nav-ico{font-size:20px;display:inline-block;transform-origin:center}
    .nav-btn .nav-label{font-size:13px}
    .nav-btn:hover{ transform:translateY(-8px) scale(1.04); filter:brightness(1.04) }
    .nav-btn.active{
      background:linear-gradient(90deg,var(--accent-2),var(--accent));
      color:#fff; box-shadow: 0 42px 120px rgba(167,108,43,0.24); transform:translateY(-12px) scale(1.06);
      animation:navPulse 1.2s ease-in-out infinite alternate;
    }
    @keyframes navPulse{
      from{ box-shadow:0 28px 82px rgba(167,108,43,0.18); transform:translateY(-10px) scale(1.04); }
      to{ box-shadow:0 60px 160px rgba(167,108,43,0.28); transform:translateY(-14px) scale(1.08); }
    }

    .day-stack-controls button{padding:6px 8px;border-radius:10px;background:rgba(0,0,0,0.04);border:0;cursor:pointer;transition:transform .12s}
    .day-stack-controls button:hover{transform:translateY(-3px);}

    .danger{background:linear-gradient(180deg,#ffb37,#ff8a00); color:#fff; box-shadow:0 18px 52px rgba(255,138,0,0.14);}

    @media(max-width:420px){
      :root{ --header-h:56px; --bottom-h:86px; }
      header{padding:8px}
      .coin-logo{width:44px;height:44px;font-size:18px}
      .app{padding:8px;padding-bottom:calc(var(--bottom-h) + 8px)}
      .panel{padding:12px}
      .btn{padding:10px 12px;font-size:15px}
      .nav-btn{min-width:72px;padding:10px 12px}
      .nav-btn .nav-ico{font-size:18px}
    }
  </style>
</head>
<body>
  <div class="app" id="appRoot">
    <header>
      <div class="logo">
        <div class="coin-logo">üçÇ</div>
        <div>
          <h1>Motywator</h1>
          <div style="font-size:12px;color:var(--muted)">Jesienna szata ‚Ä¢ #A76C2B</div>
        </div>
      </div>
      <div class="wallet">
        <div style="font-size:12px;color:var(--muted)">Stan</div>
        <div id="balance" style="font-weight:700;display:flex;align-items:center;gap:8px"><span class="wallet-coin">üéÉ</span><span id="balanceVal">0</span></div>
      </div>
    </header>

    <div class="content-viewport" id="viewport">
      <div class="content-wrapper" id="contentWrapper" aria-live="polite">
        <!-- Lobby -->
        <section class="page" id="page-lobby" aria-label="Lobby">
          <div class="panel">
            <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:center">
              <div style="flex:1;display:flex;gap:12px;min-width:220px">
                <div style="flex:1;padding:12px;border-radius:12px;background:linear-gradient(180deg,var(--accent-2),var(--accent));color:#fff">
                  <div style="font-size:12px;opacity:.95">Dni uko≈Ñczone</div>
                  <b id="statDays">0</b>
                </div>
                <div style="flex:1;padding:12px;border-radius:12px;background:linear-gradient(180deg,var(--accent-2),var(--accent));color:#fff">
                  <div style="font-size:12px;opacity:.95">Dynie</div>
                  <b id="statCoins">0</b>
                </div>
              </div>
              <div style="text-align:right;min-width:110px">
                <div class="muted" style="font-size:12px">Data</div>
                <div id="currentDateLobby" style="font-weight:700"></div>
              </div>
            </div>

            <div style="margin-top:14px;display:flex;flex-wrap:wrap;gap:8px;align-items:center">
              <input type="date" id="newDayDate" />
              <input type="text" id="newDayName" placeholder="Nazwa dnia (np. Test z matmy)" style="flex:1;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.06)" />
              <select id="newDayMode" class="click-pulse" style="padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.06)">
                <option value="with_time">Z godzinami</option>
                <option value="no_time">Bez godzin (lista)</option>
              </select>
              <button id="createNewDay" class="btn click-pulse">Utw√≥rz dzie≈Ñ</button>
            </div>

            <div style="margin-top:14px;font-weight:700;display:flex;justify-content:space-between;align-items:center">
              <div>Ostatnie dni</div>
              <div class="muted" style="font-size:13px">Przesu≈Ñ, by zobaczyƒá</div>
            </div>
            <div class="quick-grid" id="quickDays" style="margin-top:8px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px"></div>
          </div>
        </section>

        <!-- Day -->
        <section class="page" id="page-today" aria-label="Dzie≈Ñ">
          <div class="panel" id="todayPanel">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
              <div style="display:flex;align-items:center;gap:8px;flex:1">
                <div>
                  <div style="font-weight:800;display:flex;align-items:center;gap:8px">
                    <div id="dayHeaderName">(nie wybrano)</div>
                    <div class="day-stack-controls" id="dayStackControls" style="margin-left:8px">
                      <button id="prevDay" class="btn small click-pulse" style="display:none">‚óÄ</button>
                      <button id="nextDay" class="btn small click-pulse" style="display:none">‚ñ∂</button>
                    </div>
                  </div>
                  <div id="openDayLabel" class="muted" style="margin-top:6px">(data)</div>
                </div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <button id="saveDayState" class="btn small click-pulse">Zapisz</button>
                <button id="lockList" class="btn small click-pulse">Zamknij listƒô</button>
                <button id="finishDay" class="btn small click-pulse">Zako≈Ñcz dzie≈Ñ</button>
                <button id="deleteDay" class="btn small danger click-pulse" title="Usu≈Ñ ten dzie≈Ñ">Usu≈Ñ dzie≈Ñ</button>
                <button id="viewPostponed" class="btn small click-pulse" style="display:none">Od≈Ço≈ºone (0)</button>
              </div>
            </div>

            <form id="taskForm" style="margin-top:12px;display:grid;gap:8px">
              <input id="title" placeholder="Tytu≈Ç zadania" style="padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.06)" required />
              <div style="display:flex;gap:8px;align-items:center">
                <select id="category" class="click-pulse" style="padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.06);flex:1">
                  <option value="nauka">üìö Nauka ‚Äî 5 üéÉ/godz</option>
                  <option value="sprzatanie">üßπ SprzƒÖtanie ‚Äî 3 üéÉ/godz</option>
                  <option value="czas_wolny">üéÆ Czas wolny ‚Äî 2 üéÉ/godz</option>
                  <option value="inne">üîñ Inne ‚Äî 0 üéÉ</option>
                  <option value="rutyna">üåÖ Rutyna ‚Äî 2 üéÉ/godz</option>
                  <option value="roznorodne">‚ú® R√≥≈ºnorodne czynno≈õci ‚Äî 2 üéÉ/godz</option>
                </select>
                <button type="submit" id="addTaskBtn" class="btn small click-pulse">‚ûï</button>
              </div>
              <div id="timeRow" style="display:flex;gap:8px">
                <input type="time" id="start" style="flex:1;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.06)" required />
                <input type="time" id="end" style="flex:1;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.06)" required />
              </div>
            </form>

            <div class="task-list" id="tasksArea"></div>
          </div>
        </section>

        <!-- History -->
        <section class="page" id="page-history" aria-label="Historia">
          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Historia list</div>
              <div><button id="clearHistory" class="btn small click-pulse">Wyczy≈õƒá historiƒô</button></div>
            </div>
            <div id="history" style="margin-top:8px"></div>
          </div>
        </section>

      </div>
    </div>

    <!-- footer kept but text removed as requested -->
    <footer style="text-align:center;color:var(--muted);padding:8px 0"></footer>
  </div>

  <div id="bottomNav" class="bottom-nav" role="navigation" aria-label="nawigacja dolna">
    <button class="nav-btn active" data-index="0" aria-label="Lobby"><div class="nav-ico">üè†</div><div class="nav-label">Lobby</div></button>
    <button class="nav-btn" data-index="1" aria-label="Dzie≈Ñ"><div class="nav-ico">üìù</div><div class="nav-label">Dzie≈Ñ</div></button>
    <button class="nav-btn" data-index="2" aria-label="Historia"><div class="nav-ico">üìö</div><div class="nav-label">Historia</div></button>
  </div>

  <div id="postponedModalRoot" style="display:none"></div>

  <script>
    /* ====== STORAGE & HELPERS ====== */
    const LS_DAYS = 'motywator_days_mobile_v1';
    const LS_BAL = 'motywator_balance_mobile_v1';
    const LS_PUR = 'motywator_purchases_mobile_v1';
    const LS_POST = 'motywator_postponed_mobile_v1';

    const loadObj = k => { try { return JSON.parse(localStorage.getItem(k) || '{}'); } catch(e) { console.warn('loadObj parse failed', k, e); return {}; } };
    const loadArr = k => { try { return JSON.parse(localStorage.getItem(k) || '[]'); } catch(e) { console.warn('loadArr parse failed', k, e); return []; } };
    const save = (k,v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e) { console.error('save failed', k, e); } };

    function generateId(prefix='id'){ return prefix + '_' + Date.now().toString(36).slice(2,9); }
    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function minutesBetween(start, end){ if(!start||!end) return 0; const [sh,sm]=start.split(':').map(Number); const [eh,em]=end.split(':').map(Number); if(Number.isNaN(sh)||Number.isNaN(sm)||Number.isNaN(eh)||Number.isNaN(em)) return 0; let s=sh*60+sm; let e=eh*60+em; if(e<s) e+=24*60; return Math.max(0,e-s); }

    function normalizeDays(raw){
      const map = {};
      try{
        if(raw == null) return map;
        if(!Array.isArray(raw) && typeof raw === 'object'){
          Object.entries(raw).forEach(([k,v])=>{
            if(!v) return;
            if(typeof v !== 'object') return;
            const id = v.id || v.key || k || generateId('d');
            v.id = id;
            if(!Array.isArray(v.tasks)) v.tasks = v.tasks ? Object.values(v.tasks).filter(Boolean) : [];
            map[id] = v;
          });
          return map;
        }
        if(Array.isArray(raw)){
          raw.forEach(d=>{ if(!d) return; const id = d.id || d.key || generateId('d'); d.id = id; if(!Array.isArray(d.tasks)) d.tasks = d.tasks ? Object.values(d.tasks).filter(Boolean) : []; map[id] = d; });
          return map;
        }
      }catch(e){ console.error('normalizeDays failed', e); }
      return map;
    }

    /* ====== STATE ====== */
    let rawDays = loadObj(LS_DAYS);
    let days = normalizeDays(rawDays);
    let balance = Number(localStorage.getItem(LS_BAL) || 0);
    let purchases = loadArr(LS_PUR);
    let postponed = loadArr(LS_POST) || [];
    let currentOpenKey = null;
    let dayHistoryStack = [];
    let stackPos = -1;
    const ratesPerHour = { 'nauka':5,'sprzatanie':3,'czas_wolny':2,'inne':0,'rutyna':2,'roznorodne':2 };

    /* ====== ELEMENTS ====== */
    const contentWrapper = document.getElementById('contentWrapper');
    const bottomNav = document.getElementById('bottomNav');
    const navButtons = Array.from(bottomNav.querySelectorAll('.nav-btn'));
    const balanceVal = document.getElementById('balanceVal');
    const currentDateLobby = document.getElementById('currentDateLobby');
    const quickDays = document.getElementById('quickDays');
    const tasksArea = document.getElementById('tasksArea');
    const newDayDate = document.getElementById('newDayDate');
    const newDayName = document.getElementById('newDayName');
    const newDayMode = document.getElementById('newDayMode');
    const createNewDayBtn = document.getElementById('createNewDay');
    const saveDayStateBtn = document.getElementById('saveDayState');
    const lockListBtn = document.getElementById('lockList');
    const finishDayBtn = document.getElementById('finishDay');
    const deleteDayBtn = document.getElementById('deleteDay');
    const viewPostponedBtn = document.getElementById('viewPostponed');
    const historyEl = document.getElementById('history');
    const prevDayBtn = document.getElementById('prevDay');
    const nextDayBtn = document.getElementById('nextDay');
    const clearHistoryBtn = document.getElementById('clearHistory');

    const titleInp = document.getElementById('title');
    const startInp = document.getElementById('start');
    const endInp = document.getElementById('end');
    const catInp = document.getElementById('category');
    const taskForm = document.getElementById('taskForm');

    if(newDayDate) newDayDate.value = new Date().toISOString().slice(0,10);
    if(balanceVal) balanceVal.textContent = balance;
    if(currentDateLobby) currentDateLobby.textContent = new Date().toLocaleDateString();

    /* ====== NAV (instant) ====== */
    const pagesCount = 3;
    function snapToIndex(i){
      const idx = Math.max(0, Math.min(pagesCount-1, i));
      const target = -idx * 100;
      if(contentWrapper){ contentWrapper.style.transition = 'none'; contentWrapper.style.transform = `translate3d(${target}%,0,0)`; }
      navButtons.forEach(b=>b.classList.toggle('active', Number(b.dataset.index) === idx));
      renderAll();
    }
    navButtons.forEach(b=>{ b.addEventListener('click', ()=>{ snapToIndex(Number(b.dataset.index)); }); });

    /* ====== history stack for opened days ====== */
    function pushToStack(id){
      if(!id) return;
      if(stackPos < dayHistoryStack.length - 1) dayHistoryStack = dayHistoryStack.slice(0, stackPos + 1);
      if(dayHistoryStack.length === 0 || dayHistoryStack[dayHistoryStack.length -1] !== id){
        dayHistoryStack.push(id);
        stackPos = dayHistoryStack.length -1;
      } else {
        stackPos = dayHistoryStack.length -1;
      }
      updateStackButtons();
    }
    function updateStackButtons(){
      if(prevDayBtn) prevDayBtn.style.display = (stackPos > 0) ? 'inline-block' : 'none';
      if(nextDayBtn) nextDayBtn.style.display = (stackPos < dayHistoryStack.length - 1) ? 'inline-block' : 'none';
    }
    if(prevDayBtn) prevDayBtn.addEventListener('click', ()=>{ if(stackPos>0){ stackPos--; const id = dayHistoryStack[stackPos]; currentOpenKey = id; renderTasks(); snapToIndex(1); updateStackButtons(); } });
    if(nextDayBtn) nextDayBtn.addEventListener('click', ()=>{ if(stackPos < dayHistoryStack.length -1){ stackPos++; const id = dayHistoryStack[stackPos]; currentOpenKey = id; renderTasks(); snapToIndex(1); updateStackButtons(); } });

    /* ====== CORE: render / actions ====== */
    function renderStats(){ const all = Object.values(days||{}); const s = all.filter(d=>d && d.completed).length; const coins = balance; document.getElementById('statDays') && (document.getElementById('statDays').textContent = s); document.getElementById('statCoins') && (document.getElementById('statCoins').textContent = coins); if(balanceVal) balanceVal.textContent = coins; }

    function resolveDayIdentifier(keyOrDay){
      if(!keyOrDay) return null;
      if(typeof keyOrDay === 'object'){
        if(keyOrDay.id) return keyOrDay.id;
        const direct = Object.entries(days||{}).find(([k,v])=>v===keyOrDay);
        if(direct) return direct[0];
        return keyOrDay.date || keyOrDay.name || keyOrDay.key || null;
      } else return keyOrDay;
    }

    function openDay(keyOrDay){
      try{
        const resolved = resolveDayIdentifier(keyOrDay);
        if(!resolved) return;
        let targetId = null;
        if(days[resolved]) targetId = resolved;
        else {
          const found = Object.entries(days||{}).find(([k,v])=> v && (v.id===resolved || v.date===resolved || v.key===resolved || v.name===resolved));
          if(found) targetId = found[0];
        }
        if(!targetId){ console.warn('Nie znaleziono dnia dla', keyOrDay); return; }
        pushToStack(targetId);
        currentOpenKey = targetId;
        renderTasks();
        snapToIndex(1);
        setTimeout(()=>{ try{ titleInp && titleInp.focus(); }catch(e){} }, 80);
      }catch(e){ console.error('openDay failed', e); }
    }

    function deleteDayById(id){
      if(!id || !days[id]) return;
      if(!confirm('Na pewno usunƒÖƒá ten dzie≈Ñ na sta≈Çe?')) return;
      delete days[id];
      // remove from stack
      dayHistoryStack = dayHistoryStack.filter(x=>x!==id);
      if(stackPos >= dayHistoryStack.length) stackPos = dayHistoryStack.length - 1;
      if(currentOpenKey === id) currentOpenKey = null;
      save(LS_DAYS, days);
      renderAll();
    }

    function renderQuickDays(){
      if(!quickDays) return;
      quickDays.innerHTML = '';
      const entries = Object.entries(days||{}).sort((a,b)=> (b[1].created||0) - (a[1].created||0));
      entries.forEach(([key,d],i)=>{
        const card = document.createElement('div');
        card.className = 'card clickable-card enter-pop';
        card.style.animationDelay = (i*40)+'ms';
        card.style.padding='12px'; card.style.borderRadius='12px'; card.style.border='1px solid rgba(0,0,0,0.04)'; card.style.background='#fff';
        const modeLabel = d.mode === 'no_time' ? 'Lista' : 'Z godzinami';
        let preview = '';
        if(Array.isArray(d.tasks) && d.tasks.length){
          if(d.mode === 'no_time'){ preview = d.tasks.slice(0,2).map((t,idx)=>`${idx+1}. ${escapeHtml(t.title)}`).join('<br>'); if(d.tasks.length>2) preview += '<br>‚Ä¶'; }
          else { const t = d.tasks[0]; preview = `${t ? (t.start||'') + '‚Äì' + (t.end||'') + ' ‚Ä¢ ' + escapeHtml(t.title||'') : ''}`; }
        } else preview = '<span class="muted">Brak zada≈Ñ</span>';

        card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div style="flex:1">
              <div style="font-weight:800">${escapeHtml(d.name||d.date||d.id)}</div>
              <div class="muted" style="font-size:12px;margin-top:6px">${escapeHtml(d.date||'')}</div>
              <div class="day-preview">${preview}</div>
            </div>
            <div style="margin-left:12px;text-align:right">
              <div style="font-size:12px;color:var(--muted)">${escapeHtml(modeLabel)}</div>
              <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
                <button class="btn small click-pulse open-day">Otw√≥rz</button>
                <button class="btn small secondary click-pulse del-day">Usu≈Ñ</button>
              </div>
            </div>
          </div>`;

        const openBtn = card.querySelector('.open-day');
        const delBtn = card.querySelector('.del-day');
        openBtn && openBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); openDay(d); });
        delBtn && delBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); deleteDayById(d.id); });
        card.addEventListener('click', ()=>{ openDay(d); });
        quickDays.appendChild(card);
      });
      if(entries.length===0) quickDays.innerHTML = '<div class="muted">Brak dni.</div>';
    }

    function updatePostponedButton(){ if(!viewPostponedBtn) return; if(postponed.length){ viewPostponedBtn.style.display='inline-block'; viewPostponedBtn.textContent = `Od≈Ço≈ºone (${postponed.length})`; } else viewPostponedBtn.style.display='none'; }

    /* Move completed tasks to bottom when toggled.
       - when checking: remove the task and push to end.
       - when unchecking: remove and insert before first completed task (so it returns to active zone).
    */
    function toggleTaskCompleted(day, taskId, checked){
      if(!day || !Array.isArray(day.tasks)) return;
      const idx = day.tasks.findIndex(t=>t.id===taskId);
      if(idx === -1) return;
      const [task] = day.tasks.splice(idx,1);
      task.completed = !!checked;
      if(task.completed){
        day.tasks.push(task);
      } else {
        // insert before first completed, or at end of active section
        const firstCompletedIdx = day.tasks.findIndex(t=>t.completed);
        if(firstCompletedIdx === -1) day.tasks.splice(day.tasks.length,0,task);
        else day.tasks.splice(firstCompletedIdx,0,task);
      }
      save(LS_DAYS, days);
      renderTasks();
    }

    function renderTasks(){
      try{
        if(!tasksArea) return;
        tasksArea.innerHTML = '';
        if(!currentOpenKey){
          document.getElementById('dayHeaderName') && (document.getElementById('dayHeaderName').textContent='(nie wybrano)');
          document.getElementById('openDayLabel') && (document.getElementById('openDayLabel').textContent='(data)');
          taskForm && (taskForm.style.display='grid');
          if(lockListBtn) lockListBtn.style.display='inline-block';
          updatePostponedButton();
          return;
        }
        let day = days[currentOpenKey];
        if(!day){ day = Object.values(days||[]).find(d=>d && (d.id===currentOpenKey || d.date===currentOpenKey || d.key===currentOpenKey)); }
        if(!day){ currentOpenKey = null; renderTasks(); return; }

        document.getElementById('dayHeaderName') && (document.getElementById('dayHeaderName').textContent = day.name || day.date || '(brak nazwy)');
        document.getElementById('openDayLabel') && (document.getElementById('openDayLabel').textContent = (day.date||'') + (day.completed ? ' ‚Ä¢ uko≈Ñczony' : ''));
        const isLocked = !!day.locked;
        const isCompleted = !!day.completed;

        // lock only hides edit controls, but checkboxes remain available
        if(lockListBtn) lockListBtn.style.display = isLocked ? 'none' : 'inline-block';
        if(taskForm) taskForm.style.display = (isLocked || isCompleted) ? 'none' : 'grid';
        if(day.mode === 'no_time'){ document.getElementById('timeRow') && (document.getElementById('timeRow').style.display='none'); if(startInp) startInp.required=false; if(endInp) endInp.required=false; }
        else { document.getElementById('timeRow') && (document.getElementById('timeRow').style.display='flex'); if(startInp) startInp.required=true; if(endInp) endInp.required=true; }

        if(!Array.isArray(day.tasks) || !day.tasks.length){ tasksArea.innerHTML = '<div class="muted">Brak zada≈Ñ.</div>'; updatePostponedButton(); return; }

        day.tasks.forEach((t, idx)=>{
          const el = document.createElement('div'); el.className='task enter-pop'; if(t.completed) el.classList.add('completed');
          const meta = document.createElement('div'); meta.className='meta'; meta.style.flex='1';
          const timeText = day.mode==='no_time' ? `#${idx+1}` : `${t.start||''}‚Äì${t.end||''}`;
          meta.innerHTML = `<b>${escapeHtml(t.title)} ${t.postponed?'<span class="task-badge" style="color:var(--accent-3);font-weight:700;margin-left:6px">OD≈ÅO≈ªONO</span>':''}</b><div class="tags muted">${timeText} ‚Ä¢ ${escapeHtml(t.category)}</div>`;

          const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';
          // always show checkbox (even when locked) ‚Äî toggling allowed when locked
          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = !!t.completed;
          cb.addEventListener('change', (ev)=>{ ev.stopPropagation(); try{ toggleTaskCompleted(day, t.id, cb.checked); }catch(e){ console.error(e); } });
          right.appendChild(cb);

          // If not locked & not completed -> show edit controls
          if(!isLocked && !isCompleted){
            if(day.mode === 'no_time'){
              const up = document.createElement('button'); up.className='btn small click-pulse'; up.textContent='‚Üë'; up.title='Przenie≈õ wy≈ºej'; up.addEventListener('click', (ev)=>{ ev.stopPropagation(); if(idx<=0) return; [day.tasks[idx-1], day.tasks[idx]] = [day.tasks[idx], day.tasks[idx-1]]; save(LS_DAYS,days); renderTasks(); });
              const down = document.createElement('button'); down.className='btn small click-pulse'; down.textContent='‚Üì'; down.title='Przenie≈õ ni≈ºej'; down.addEventListener('click', (ev)=>{ ev.stopPropagation(); if(idx>=day.tasks.length-1) return; [day.tasks[idx+1], day.tasks[idx]] = [day.tasks[idx], day.tasks[idx+1]]; save(LS_DAYS,days); renderTasks(); });
              right.appendChild(up); right.appendChild(down);
            }
            const del = document.createElement('button'); del.className='btn secondary small click-pulse'; del.textContent='Usu≈Ñ'; del.addEventListener('click', (ev)=>{ ev.stopPropagation(); if(confirm('Usu≈Ñ zadanie?')){ day.tasks = day.tasks.filter(x=>x.id!==t.id); save(LS_DAYS,days); renderTasks(); } });
            right.appendChild(del);
            const dots = document.createElement('button'); dots.className='btn small click-pulse'; dots.textContent='‚ãØ'; dots.addEventListener('click', (ev)=>{ ev.stopPropagation(); const action = prompt('Napisz: "o" ≈ºeby od≈Ço≈ºyƒá/od≈Ço≈ºyƒá z powrotem, "e" ≈ºeby edytowaƒá tytu≈Ç.'); if(!action) return; if(action.toLowerCase().includes('o')){ t.postponed = !t.postponed; if(t.postponed) postponed.unshift({id:generateId('pst'), title:t.title, category:t.category, sourceDayId: currentOpenKey, originalId: t.id, originalTask:Object.assign({}, t)}); else postponed = postponed.filter(p=>!(p.sourceDayId===currentOpenKey && p.originalId===t.id)); save(LS_POST,postponed); save(LS_DAYS,days); renderTasks(); } else if(action.toLowerCase().includes('e')){ const nt = prompt('Nowy tytu≈Ç', t.title); if(nt!==null){ t.title = nt.trim(); save(LS_DAYS,days); renderTasks(); } } });
            right.appendChild(dots);
          } else {
            // locked/completed: only show 'wykonane' label for completed tasks (optional)
            if(t.completed){
              const done = document.createElement('div'); done.style.fontWeight='700'; done.style.color='var(--muted)'; done.textContent='wykonane'; right.appendChild(done);
            }
          }

          el.appendChild(meta); el.appendChild(right); tasksArea.appendChild(el);
        });

        setTimeout(()=>{ document.querySelectorAll('.task').forEach(n=>n.classList.remove('enter-pop')); }, 400);
        updatePostponedButton();
      }catch(e){ console.error('renderTasks failed', e); }
    }

    function renderHistory(){
      if(!historyEl) return;
      historyEl.innerHTML = '';
      const entries = Object.entries(days||{}).sort((a,b)=> (b[1].created||0) - (a[1].created||0));
      if(!entries.length){ historyEl.innerHTML = '<div class="muted">Brak dni</div>'; return; }
      entries.forEach(([key,d],i)=>{
        const el = document.createElement('div');
        el.style.padding='10px'; el.style.border='1px solid rgba(0,0,0,0.04)'; el.style.borderRadius='12px'; el.style.marginBottom='10px';
        el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:800">${escapeHtml(d.name||d.date||d.id)} <span class="muted">‚Ä¢ ${escapeHtml(d.date||'')}</span></div><div class="muted" style="margin-top:6px">Zada≈Ñ: ${((d.tasks||[]).length)}</div></div><div style="display:flex;gap:8px"><button class="btn small click-pulse open">Otw√≥rz</button><button class="btn small secondary click-pulse del">Usu≈Ñ</button></div></div>`;
        historyEl.appendChild(el);
        el.classList.add('enter-pop'); el.style.animationDelay = (i*40)+'ms';
        el.querySelector('.open') && el.querySelector('.open').addEventListener('click', ()=>{ openDay(d); });
        el.querySelector('.del') && el.querySelector('.del').addEventListener('click', ()=>{ deleteDayById(d.id); });
        el.addEventListener('click', (ev)=>{ if(ev.target.tagName && ev.target.tagName.toLowerCase()==='button') return; openDay(d); });
      });
    }

    function renderAll(){
      try{
        save(LS_DAYS, days);
        save(LS_PUR, purchases);
        localStorage.setItem(LS_BAL, balance);
        save(LS_POST, postponed);
        renderStats();
        renderQuickDays();
        renderTasks();
        renderHistory();
        updateStackButtons();
      }catch(e){ console.error('renderAll failed', e); }
    }

    /* ====== EVENTS ====== */
    if(createNewDayBtn) createNewDayBtn.addEventListener('click', ()=>{
      try{
        const date = newDayDate.value || new Date().toISOString().slice(0,10);
        const name = (newDayName.value||'').trim();
        const mode = (newDayMode.value || 'with_time');
        const id = generateId('d');
        days[id] = {id,date,name,mode,tasks:[],locked:false,completed:false,created:Date.now()};
        save(LS_DAYS, days);
        currentOpenKey = id;
        pushToStack(id);
        newDayName.value = '';
        renderAll();
        snapToIndex(1);
        setTimeout(()=>{ try{ titleInp && titleInp.focus(); }catch(e){} }, 80);
      }catch(e){ console.error('createNewDay failed', e); }
    });

    if(taskForm) taskForm.addEventListener('submit', (e)=>{ e.preventDefault(); try{ if(!currentOpenKey) return alert('Wybierz dzie≈Ñ.'); const title = titleInp.value.trim(); const category = catInp.value; let day = days[currentOpenKey]; if(!day) day = Object.values(days||[]).find(d=>d && (d.id===currentOpenKey || d.date===currentOpenKey)); if(!title) return alert('Wype≈Çnij tytu≈Ç.'); if(day.mode === 'with_time'){ const s = startInp.value; const ed = endInp.value; if(!s||!ed) return alert('Wype≈Çnij godziny.'); day.tasks.push({id:generateId('t'), title, start:s, end:ed, category, completed:false, postponed:false}); } else { day.tasks.push({id:generateId('t'), title, start:'', end:'', category, completed:false, postponed:false}); } save(LS_DAYS,days); titleInp.value=''; startInp.value=''; endInp.value=''; renderTasks(); }catch(e){ console.error('add task failed', e); } });

    if(lockListBtn) lockListBtn.addEventListener('click', ()=>{ try{ if(!currentOpenKey) return alert('Brak otwartego dnia.'); const day = days[currentOpenKey] || Object.values(days||[]).find(d=>d && d.id===currentOpenKey); if(!day) return; if(!confirm('Na pewno zamknƒÖƒá listƒô? Po zamkniƒôciu nie bƒôdzie mo≈ºliwo≈õci edycji tej listy (ale nadal mo≈ºna odhaczaƒá zadania).')) return; day.locked = true; save(LS_DAYS,days); renderTasks(); }catch(e){ console.error('lock failed', e); } });

    if(finishDayBtn) finishDayBtn.addEventListener('click', ()=>{ try{ if(!currentOpenKey) return alert('Brak otwartego dnia.'); const day = days[currentOpenKey] || Object.values(days||[]).find(d=>d && d.id===currentOpenKey); if(!day) return; if(day.completed) return alert('Dzie≈Ñ ju≈º zako≈Ñczony.'); if(!confirm('Zako≈Ñczyƒá dzie≈Ñ i rozliczyƒá dynie za wykonane zadania?')) return; let gained = 0; (day.tasks||[]).forEach(t=>{ if(t.postponed) return; if(!t.completed) return; const rate = ratesPerHour[t.category] || 0; if(day.mode === 'with_time'){ const mins = minutesBetween(t.start,t.end); gained += (mins/60) * rate; } else gained += rate; }); gained = Math.round(gained); balance += gained; day.completed = true; day.locked = true; save(LS_DAYS,days); localStorage.setItem(LS_BAL,balance); renderAll(); alert(`Dzie≈Ñ zako≈Ñczony. Zdobyto +${gained} üéÉ.`); }catch(e){ console.error('finish failed', e); } });

    if(deleteDayBtn) deleteDayBtn.addEventListener('click', ()=>{ if(!currentOpenKey) return alert('Brak otwartego dnia.'); deleteDayById(currentOpenKey); });

    if(viewPostponedBtn) viewPostponedBtn.addEventListener('click', ()=>{ renderPostponedModal(); });

    if(clearHistoryBtn) clearHistoryBtn.addEventListener('click', ()=>{ if(!confirm('Wyczy≈õciƒá historiƒô wszystkich dni (usuwa zapis)?')) return; days = {}; save(LS_DAYS, days); currentOpenKey = null; dayHistoryStack = []; stackPos = -1; renderAll(); });

    /* postponed modal */
    function renderPostponedModal(){ const root = document.getElementById('postponedModalRoot'); if(!root) return; root.innerHTML = ''; if(!postponed.length) return; const back = document.createElement('div'); back.style.position='fixed'; back.style.inset='0'; back.style.background='rgba(0,0,0,0.35)'; back.style.display='flex'; back.style.alignItems='center'; back.style.justifyContent='center'; back.style.zIndex='999'; const modal = document.createElement('div'); modal.style.background='#fff'; modal.style.padding='16px'; modal.style.borderRadius='12px'; modal.style.maxWidth='720px'; modal.style.width='92%'; modal.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">Od≈Ço≈ºone zadania</div><div><button id="closePost" class="btn small">Zamknij</button></div></div><div id="pstList" style="margin-top:12px"></div>`; back.appendChild(modal); root.appendChild(back); document.getElementById('closePost') && document.getElementById('closePost').addEventListener('click', ()=>{ root.innerHTML=''; }); const list = modal.querySelector('#pstList'); postponed.forEach(p=>{ const item = document.createElement('div'); item.style.display='flex'; item.style.justifyContent='space-between'; item.style.alignItems='center'; item.style.padding='8px'; item.style.borderBottom='1px solid rgba(0,0,0,.04)'; item.innerHTML = `<div><div style="font-weight:700">${escapeHtml(p.title)}</div><div class="muted" style="font-size:12px">Kategoria: ${escapeHtml(p.category)}</div></div>`; const btns = document.createElement('div'); const restore = document.createElement('button'); restore.className='btn small click-pulse'; restore.textContent='Przywr√≥ƒá'; restore.addEventListener('click', ()=>{ if(!currentOpenKey){ alert('Otw√≥rz dzie≈Ñ, do kt√≥rego chcesz dodaƒá zadanie.'); return; } const d = days[currentOpenKey] || Object.values(days||[]).find(dd=>dd && dd.id===currentOpenKey); d.tasks = d.tasks || []; d.tasks.push({id:generateId('t'), title:p.title, start:p.originalTask?.start||'', end:p.originalTask?.end||'', category:p.category, completed:false, postponed:false}); postponed = postponed.filter(x=>x.id!==p.id); save(LS_POST,postponed); save(LS_DAYS,days); renderAll(); renderPostponedModal(); }); const remove = document.createElement('button'); remove.className='btn small secondary click-pulse'; remove.textContent='Usu≈Ñ'; remove.addEventListener('click', ()=>{ if(confirm('Usu≈Ñ od≈Ço≈ºone zadanie?')){ postponed = postponed.filter(x=>x.id!==p.id); save(LS_POST,postponed); renderPostponedModal(); } }); btns.appendChild(restore); btns.appendChild(remove); item.appendChild(btns); list.appendChild(item); }); }

    /* ====== BOOT ====== */
    (function boot(){
      try{
        rawDays = loadObj(LS_DAYS);
        days = normalizeDays(rawDays);
        save(LS_DAYS,days);
      }catch(e){ console.error('boot failed', e); }
    })();

    window.Motywator = {days, balance, purchases, postponed, snapToIndex, openDay, dayHistoryStack};
    snapToIndex(0);
    renderAll();
    window.addEventListener('beforeunload', ()=>{ try{ save(LS_DAYS,days); save(LS_PUR,purchases); save(LS_POST,postponed); localStorage.setItem(LS_BAL,balance); }catch(e){} });

    /* ripple for .click-pulse */
    (function(){
      let activeElem = null;
      function onDown(e){ try{ const el = e.currentTarget; activeElem = el; el.classList.add('press'); const rect = el.getBoundingClientRect(); const x = (e.touches?e.touches[0].clientX:e.clientX) - rect.left; const y = (e.touches?e.touches[0].clientY:e.clientY) - rect.top; const r = Math.max(rect.width, rect.height); const span = document.createElement('span'); span.className='ripple'; span.style.width = span.style.height = (r*2.2) + 'px'; span.style.left = x + 'px'; span.style.top = y + 'px'; el.appendChild(span); setTimeout(()=>{ try{ el.removeChild(span);}catch(e){} }, 700); }catch(e){console.error('ripple onDown failed',e);} }
      function onUp(e){ try{ if(!activeElem) return; activeElem.classList.remove('press'); activeElem = null; }catch(e){console.error('ripple onUp failed',e);} }
      function attach(el){ try{ el.addEventListener('touchstart', onDown, {passive:true}); el.addEventListener('mousedown', onDown); el.addEventListener('touchend', onUp); el.addEventListener('mouseup', onUp); el.addEventListener('mouseleave', onUp); }catch(e){}}
      document.querySelectorAll('.click-pulse').forEach(attach);
      const obs = new MutationObserver(m=>{ m.forEach(rec=>{ rec.addedNodes && rec.addedNodes.forEach(node=>{ try{ if(node.querySelectorAll) node.querySelectorAll('.click-pulse').forEach(attach); if(node.classList && node.classList.contains && node.classList.contains('click-pulse')) attach(node); }catch(e){} }); }); });
      obs.observe(document.body,{childList:true,subtree:true});
    })();
  </script>
</body>
</html>
