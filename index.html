<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Motywator szkolny — smooth nav + mobile fit</title>
  <style>
    :root{
      --bg:#FFFFFF;
      --accent:#BACCAE;
      --accent-2:#9FBDA8;
      --card:#FFFFFF;
      --text:#183925;
      --muted:#6b6b6b;
      --radius:12px;
      --coin:#F2C94C;
      --header-h:64px;
      --bottom-h:86px;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#fbfffb,#f7fff8);color:var(--text);-webkit-font-smoothing:antialiased}
    .app{max-width:980px;margin:0 auto;padding:12px;min-height:100vh;position:relative;padding-bottom:calc(var(--bottom-h) + 16px)}
    header{height:var(--header-h);display:flex;align-items:center;gap:12px;padding:12px}
    .logo{display:flex;align-items:center;gap:10px}
    .coin-logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(145deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;box-shadow:0 10px 30px rgba(159,189,168,0.12)}
    h1{font-size:18px;margin:0}
    .wallet{display:flex;align-items:center;gap:12px;margin-left:auto}
    .wallet-coin{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:linear-gradient(145deg,#ffd66b,#f5b800);box-shadow:0 6px 18px rgba(0,0,0,0.06);font-weight:700}

    /* content */
    .content-viewport{position:relative;overflow:hidden;border-radius:var(--radius);max-width:980px;margin:0 auto}
    .content-wrapper{display:flex;will-change:transform;transform:translate3d(0,0,0);touch-action:pan-y; /* prefer vertical scroll by default */ }
    .page{flex:0 0 100%;height:calc(100vh - var(--header-h) - var(--bottom-h) - 24px); /* 24px for padding */ overflow:auto;padding:12px}
    .panel{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(0,0,0,0.03);min-height:100%}

    /* small helpers & visually consistent */
    .muted{color:var(--muted)}
    .btn{background:linear-gradient(180deg,var(--accent-2),var(--accent));border:0;color:#fff;padding:10px 14px;border-radius:14px;cursor:pointer;font-weight:700;box-shadow:0 10px 30px rgba(159,189,168,0.06);transition:transform .12s ease}
    .btn:active{transform:scale(.98)}
    .btn.small{padding:8px 10px;border-radius:12px;font-size:14px}
    .btn.secondary{background:#fff;color:var(--text);border:1px solid rgba(0,0,0,0.06)}
    .click-pulse{touch-action:none}
    .enter-pop{animation:popIn .36s ease both}
    @keyframes popIn{from{transform:translateY(12px);opacity:0}to{transform:translateY(0);opacity:1}}

    /* tasks (kept similar to before) */
    .task-list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .task{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);background:#fff;position:relative}
    .task.completed{border-left:4px solid var(--accent);background:linear-gradient(90deg,rgba(159,189,168,0.03),#fff)}
    .task .meta b{display:block}
    .task .tags{font-size:13px;color:var(--muted);margin-top:6px}
    input[type="checkbox"]{width:18px;height:18px;accent-color:#2f9e66;cursor:pointer}

    /* bottom nav */
    .bottom-nav{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:12px;
      height:var(--bottom-h);
      display:flex;
      align-items:center;
      gap:8px;
      padding:12px 14px;
      border-radius:999px;
      background:linear-gradient(180deg,rgba(255,255,255,0.98),#fff);
      box-shadow:0 24px 60px rgba(0,0,0,0.12);
      z-index:200;
      touch-action:none;
      backdrop-filter:blur(6px);
      max-width:960px;
      width:calc(100% - 24px);
      user-select:none;
    }
    .nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;padding:8px;border-radius:10px;background:transparent;border:0;cursor:pointer;font-weight:700;color:var(--muted);transition:all .18s}
    .nav-btn.active{background:linear-gradient(180deg,var(--accent-2),var(--accent));color:#083018;box-shadow:0 10px 30px rgba(159,189,168,0.12)}
    .nav-ico{font-size:18px}

    /* responsive tweaks */
    @media(max-width:720px){
      header{padding:10px}
      .app{padding:8px;padding-bottom:calc(var(--bottom-h) + 8px)}
      .bottom-nav{padding:8px;gap:6px}
      .nav-btn{gap:4px;padding:6px}
    }
  </style>
</head>
<body>
  <div class="app" id="appRoot">
    <header>
      <div class="logo">
        <div class="coin-logo">🌿</div>
        <div>
          <h1>Motywator szkolny</h1>
          <div style="font-size:12px;color:var(--muted)">Estetycznie • Prosto • #BACCAE</div>
        </div>
      </div>
      <div class="wallet">
        <div style="font-size:12px;color:var(--muted)">Stan</div>
        <div id="balance" style="font-weight:700;display:flex;align-items:center;gap:8px"><span class="wallet-coin">🪙</span><span id="balanceVal">0</span></div>
      </div>
    </header>

    <div class="content-viewport" id="viewport">
      <div class="content-wrapper" id="contentWrapper" aria-live="polite">
        <!-- Page 0: Lobby -->
        <section class="page" id="page-lobby" aria-label="Lobby">
          <div class="panel">
            <div style="display:flex;gap:12px;align-items:center">
              <div style="flex:1;display:flex;gap:12px">
                <div style="flex:1;padding:12px;border-radius:12px;background:linear-gradient(180deg,var(--accent-2),var(--accent));color:#fff">
                  <div style="font-size:12px;opacity:.95">Dni ukończone</div>
                  <b id="statDays">0</b>
                </div>
                <div style="flex:1;padding:12px;border-radius:12px;background:linear-gradient(180deg,var(--accent-2),var(--accent));color:#fff">
                  <div style="font-size:12px;opacity:.95">Monety</div>
                  <b id="statCoins">0</b>
                </div>
              </div>
              <div style="text-align:right">
                <div class="muted" style="font-size:12px">Data</div>
                <div id="currentDateLobby" style="font-weight:700"></div>
              </div>
            </div>

            <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
              <input type="date" id="newDayDate" />
              <input type="text" id="newDayName" placeholder="Nazwa dnia (np. Test z matmy)" style="flex:1;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.06)" />
              <select id="newDayMode" class="click-pulse" style="padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.06)">
                <option value="with_time">Z godzinami</option>
                <option value="no_time">Bez godzin (lista)</option>
              </select>
              <button id="createNewDay" class="btn click-pulse">Utwórz dzień</button>
            </div>

            <div style="margin-top:14px;font-weight:700">Ostatnie dni</div>
            <div class="quick-grid" id="quickDays" style="margin-top:8px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px"></div>
          </div>
        </section>

        <!-- Page 1: Today -->
        <section class="page" id="page-today" aria-label="Dzień">
          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:800" id="dayHeaderName">(nie wybrano)</div>
                <div id="openDayLabel" class="muted" style="margin-top:6px">(data)</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <button id="saveDayState" class="btn small click-pulse">Zapisz</button>
                <button id="lockList" class="btn small click-pulse">Zamknij listę</button>
                <button id="finishDay" class="btn small click-pulse">Zakończ dzień</button>
                <button id="viewPostponed" class="btn small click-pulse" style="display:none">Odłożone (0)</button>
              </div>
            </div>

            <form id="taskForm" style="margin-top:12px;display:grid;gap:8px">
              <input id="title" placeholder="Tytuł zadania" style="padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.06)" required />
              <div style="display:flex;gap:8px;align-items:center">
                <select id="category" class="click-pulse" style="padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.06);flex:1">
                  <option value="nauka">📚 Nauka — 5 🪙/godz</option>
                  <option value="sprzatanie">🧹 Sprzątanie — 3 🪙/godz</option>
                  <option value="czas_wolny">🎮 Czas wolny — 2 🪙/godz</option>
                  <option value="inne">🔖 Inne — 0 🪙</option>
                  <option value="rutyna">🌅 Rutyna — 2 🪙/godz</option>
                  <option value="roznorodne">✨ Różnorodne czynności — 2 🪙/godz</option>
                </select>
                <button type="submit" id="addTaskBtn" class="btn small click-pulse">➕</button>
              </div>
              <div id="timeRow" style="display:flex;gap:8px">
                <input type="time" id="start" style="flex:1;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.06)" required />
                <input type="time" id="end" style="flex:1;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.06)" required />
              </div>
            </form>

            <div class="task-list" id="tasksArea"></div>
          </div>
        </section>

        <!-- Page 2: Shop -->
        <section class="page" id="page-shop" aria-label="Sklep">
          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Sklep</div>
              <div class="muted" style="font-size:13px">Wydawaj monety na nagrody</div>
            </div>

            <div style="margin-top:12px;padding:28px;border-radius:12px;background:linear-gradient(180deg,rgba(159,189,168,0.06),rgba(159,189,168,0.02));text-align:center;font-weight:700;color:var(--muted)">
              <div style="font-size:18px">Oferty wkrótce...</div>
              <div style="font-size:13px;margin-top:8px;color:var(--muted)">Sklep chwilowo nieaktywny — tu pojawią się nagrody!</div>
            </div>

            <div style="margin-top:18px">
              <div style="font-weight:700">Historia zakupów</div>
              <div id="purchases" style="margin-top:8px;max-height:220px;overflow:auto" class="enter-pop"></div>
            </div>
          </div>
        </section>

        <!-- Page 3: History -->
        <section class="page" id="page-history" aria-label="Historia">
          <div class="panel">
            <div style="font-weight:700">Historia list</div>
            <div id="history" style="margin-top:8px"></div>
          </div>
        </section>

      </div>
    </div>

    <footer style="text-align:center;color:var(--muted);padding:8px 0">Stworzono z myślą o koncentracji — prostota i #BACCAE</footer>
  </div>

  <div id="bottomNav" class="bottom-nav" role="navigation" aria-label="nawigacja dolna">
    <button class="nav-btn active" data-index="0" aria-label="Lobby"><div class="nav-ico">🏠</div><div style="font-size:12px">Lobby</div></button>
    <button class="nav-btn" data-index="1" aria-label="Dzień"><div class="nav-ico">📝</div><div style="font-size:12px">Dzień</div></button>
    <button class="nav-btn" data-index="2" aria-label="Sklep"><div class="nav-ico">🛍️</div><div style="font-size:12px">Sklep</div></button>
    <button class="nav-btn" data-index="3" aria-label="Historia"><div class="nav-ico">📚</div><div style="font-size:12px">Historia</div></button>
  </div>

  <div id="postponedModalRoot" style="display:none"></div>

  <script>
    /* ====== STORAGE & HELPERS (unchanged behaviour) ====== */
    const LS_DAYS = 'motywator_days_mobile_v1';
    const LS_BAL = 'motywator_balance_mobile_v1';
    const LS_PUR = 'motywator_purchases_mobile_v1';
    const LS_POST = 'motywator_postponed_mobile_v1';

    const loadObj = k => { try{return JSON.parse(localStorage.getItem(k)||'{}')}catch(e){return {}} };
    const loadArr = k => { try{return JSON.parse(localStorage.getItem(k)||'[]')}catch(e){return []} };
    const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));

    let days = loadObj(LS_DAYS);
    let balance = Number(localStorage.getItem(LS_BAL) || 0);
    let purchases = loadArr(LS_PUR);
    let postponed = loadArr(LS_POST) || [];
    let currentOpenKey = null;

    const ratesPerHour = {
      'nauka': 5,
      'sprzatanie': 3,
      'czas_wolny': 2,
      'inne': 0,
      'rutyna': 2,
      'roznorodne': 2
    };

    function generateId(prefix='id'){ return prefix + '_' + Date.now().toString(36).slice(2,9); }
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function minutesBetween(start, end){
      if(!start||!end) return 0;
      const [sh,sm] = start.split(':').map(Number);
      const [eh,em] = end.split(':').map(Number);
      if(Number.isNaN(sh)||Number.isNaN(sm)||Number.isNaN(eh)||Number.isNaN(em)) return 0;
      let s = sh*60+sm; let e = eh*60+em; if(e<s) e += 24*60; return Math.max(0, e - s);
    }

    /* ====== ELEMENTS ====== */
    const contentWrapper = document.getElementById('contentWrapper');
    const viewport = document.getElementById('viewport');
    const bottomNav = document.getElementById('bottomNav');
    const navButtons = Array.from(bottomNav.querySelectorAll('.nav-btn'));
    const balanceVal = document.getElementById('balanceVal');
    const currentDateLobby = document.getElementById('currentDateLobby');
    const quickDays = document.getElementById('quickDays');
    const tasksArea = document.getElementById('tasksArea');
    const newDayDate = document.getElementById('newDayDate');
    const newDayName = document.getElementById('newDayName');
    const newDayMode = document.getElementById('newDayMode');
    const createNewDayBtn = document.getElementById('createNewDay');
    const saveDayStateBtn = document.getElementById('saveDayState');
    const lockListBtn = document.getElementById('lockList');
    const finishDayBtn = document.getElementById('finishDay');
    const viewPostponedBtn = document.getElementById('viewPostponed');

    // inputs
    const titleInp = document.getElementById('title');
    const startInp = document.getElementById('start');
    const endInp = document.getElementById('end');
    const catInp = document.getElementById('category');
    const taskForm = document.getElementById('taskForm');
    const purchasesEl = document.getElementById('purchases');
    const historyEl = document.getElementById('history');

    if(newDayDate) newDayDate.value = new Date().toISOString().slice(0,10);
    if(balanceVal) balanceVal.textContent = balance;
    if(currentDateLobby) currentDateLobby.textContent = new Date().toLocaleDateString();

    /* ====== NAV + SMOOTH DRAG/INERTIA ====== */
    let currentIndex = 0; // 0..3
    const pagesCount = 4;
    let viewportW = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
    let isPointerDown = false;
    let startX = 0;
    let lastX = 0;
    let lastT = 0;
    let velocity = 0;
    let baseTranslate = 0; // percent
    let rafId = null;

    function setTranslatePercent(pct, animate=false){
      if(animate) contentWrapper.style.transition = 'transform .36s cubic-bezier(.2,.9,.2,1)';
      else contentWrapper.style.transition = 'none';
      contentWrapper.style.transform = `translate3d(${pct}%,0,0)`;
    }

    function snapToIndex(i, animate=true){
      currentIndex = Math.max(0, Math.min(pagesCount-1, i));
      const target = -currentIndex * 100;
      setTranslatePercent(target, animate);
      baseTranslate = target;
      updateNavButtons();
      renderAll(); // keep contents updated
    }

    function updateNavButtons(){
      navButtons.forEach(b => b.classList.toggle('active', Number(b.dataset.index) === currentIndex));
    }

    // get pointer X (mouse or touch)
    function pointerX(e){
      return e.touches ? e.touches[0].clientX : e.clientX;
    }

    // pointer down on content or bottom nav
    function onPointerDown(e){
      // ignore right-click etc
      if(e.button && e.button !== 0) return;
      isPointerDown = true;
      startX = pointerX(e);
      lastX = startX;
      lastT = performance.now();
      velocity = 0;
      // current transform percent base
      baseTranslate = -currentIndex * 100;
      contentWrapper.style.transition = 'none';
      // capture mouse/touch move/up
      window.addEventListener('mousemove', onPointerMove, {passive:false});
      window.addEventListener('mouseup', onPointerUp);
      window.addEventListener('touchmove', onPointerMove, {passive:false});
      window.addEventListener('touchend', onPointerUp);
      // prevent text selection
      e.preventDefault && e.preventDefault();
    }

    function onPointerMove(e){
      if(!isPointerDown) return;
      const x = pointerX(e);
      const dx = x - startX;
      const pct = baseTranslate + (dx / viewportW) * 100;
      // rubber band effect at edges
      let pctEffective = pct;
      if(pct > 10) pctEffective = 10 + (pct - 10) * 0.2;
      if(pct < -100*(pagesCount-1) - 10) {
        const over = pct + 100*(pagesCount-1);
        pctEffective = -100*(pagesCount-1) - 10 + over*0.2;
      }
      setTranslatePercent(pctEffective, false);

      // velocity calc
      const now = performance.now();
      const dt = Math.max(1, now - lastT);
      velocity = (x - lastX) / dt; // px per ms
      lastX = x; lastT = now;

      // block vertical scroll if horizontal move significant
      if(e.touches && Math.abs(x - startX) > 8) e.preventDefault();
    }

    function onPointerUp(e){
      if(!isPointerDown) return;
      isPointerDown = false;
      // remove listeners
      window.removeEventListener('mousemove', onPointerMove);
      window.removeEventListener('mouseup', onPointerUp);
      window.removeEventListener('touchmove', onPointerMove);
      window.removeEventListener('touchend', onPointerUp);

      const endX = pointerX(e);
      const dxTotal = endX - startX;
      const movedPct = (dxTotal / viewportW) * 100;
      // project by velocity for inertia
      const projection = velocity * 180; // scale factor (px/ms * ms) => px
      const projPct = (projection / viewportW) * 100;
      const finalPct = -currentIndex * 100 + movedPct + projPct;

      // determine target index by finalPct
      let targetIndex = Math.round(-finalPct / 100);
      // also allow small moves to remain if not enough
      if(Math.abs(movedPct) < 10 && Math.abs(velocity) < 0.15){
        targetIndex = currentIndex;
      }
      targetIndex = Math.max(0, Math.min(pagesCount - 1, targetIndex));
      snapToIndex(targetIndex, true);
    }

    // attach pointer down to both content and bottom nav for convenience
    contentWrapper.addEventListener('mousedown', onPointerDown);
    contentWrapper.addEventListener('touchstart', onPointerDown, {passive:false});
    bottomNav.addEventListener('mousedown', onPointerDown);
    bottomNav.addEventListener('touchstart', onPointerDown, {passive:false});

    // nav button clicks
    navButtons.forEach(b=>{
      b.addEventListener('click', ()=>{
        const idx = Number(b.dataset.index);
        snapToIndex(idx, true);
      });
    });

    // handle resize - ensure proper viewport width used
    window.addEventListener('resize', ()=>{ viewportW = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0); snapToIndex(currentIndex, false); });

    /* ===== APP LOGIC: days, tasks etc (kept and adapted) ===== */
    function renderStats(){ const all = Object.values(days); document.getElementById('statDays').textContent = all.filter(d=>d.completed).length; document.getElementById('statCoins').textContent = balance; if(balanceVal) balanceVal.textContent = balance; }

    function renderQuickDays(){
      quickDays.innerHTML = '';
      const all = Object.values(days).sort((a,b)=>b.created - a.created);
      all.forEach(d=>{
        const card = document.createElement('div');
        card.style.padding='12px'; card.style.borderRadius='12px'; card.style.border='1px solid rgba(0,0,0,0.05)'; card.style.background='#fff';
        card.innerHTML = `<div style="font-weight:800">${escapeHtml(d.name||d.date)}</div><div class="muted" style="font-size:12px">${d.date} ${d.completed? '• ukończony':''}</div><div class="muted" style="margin-top:8px">Zadań: ${(d.tasks||[]).length}</div>`;
        const open = document.createElement('button'); open.className='btn small'; open.style.marginTop='8px'; open.textContent = d.completed ? 'Podejrzyj' : 'Otwórz';
        open.addEventListener('click', ()=>{ currentOpenKey = d.id; snapToIndex(1,true); renderAll(); });
        card.appendChild(open);
        quickDays.appendChild(card);
      });
    }

    function updatePostponedButton(){ if(!viewPostponedBtn) return; if(postponed.length){ viewPostponedBtn.style.display='inline-block'; viewPostponedBtn.textContent = `Odłożone (${postponed.length})`; } else viewPostponedBtn.style.display='none'; }

    function renderTasks(){
      tasksArea.innerHTML = '';
      if(!currentOpenKey){ document.getElementById('dayHeaderName').textContent='(nie wybrano)'; document.getElementById('openDayLabel').textContent='(data)'; taskForm.style.display='grid'; lockListBtn.style.display='inline-block'; updatePostponedButton(); return; }
      const day = days[currentOpenKey];
      if(!day){ currentOpenKey = null; renderTasks(); return; }
      document.getElementById('dayHeaderName').textContent = day.name || day.date;
      document.getElementById('openDayLabel').textContent = day.date + (day.completed ? ' • ukończony' : '');
      const isLocked = !!day.locked;
      const isCompleted = !!day.completed;
      lockListBtn.style.display = isLocked ? 'none' : 'inline-block';
      taskForm.style.display = (isLocked || isCompleted) ? 'none' : 'grid';
      // time row visibility
      if(day.mode === 'no_time'){ document.getElementById('timeRow').style.display='none'; startInp.required=false; endInp.required=false; } else { document.getElementById('timeRow').style.display='flex'; startInp.required=true; endInp.required=true; }

      if(!day.tasks || !day.tasks.length){ tasksArea.innerHTML = '<div class="muted">Brak zadań.</div>'; updatePostponedButton(); return; }

      day.tasks.forEach((t, idx)=>{
        const el = document.createElement('div'); el.className='task'; if(t.completed) el.classList.add('completed');
        const meta = document.createElement('div'); meta.className='meta';
        const timeText = day.mode==='no_time' ? `#${idx+1}` : `${t.start}–${t.end}`;
        meta.innerHTML = `<b>${escapeHtml(t.title)} ${t.postponed?'<span class="task-badge">ODŁOŻONO</span>':''}</b><div class="tags muted">${timeText} • ${escapeHtml(t.category)}</div>`;
        const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';
        if(!isLocked && !isCompleted){
          const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!t.completed;
          cb.addEventListener('change', ()=>{ t.completed = cb.checked; save(LS_DAYS,days); renderTasks(); });
          right.appendChild(cb);
          // reorder (buttons)
          if(day.mode === 'no_time'){
            const up = document.createElement('button'); up.className='btn small'; up.textContent='↑'; up.addEventListener('click', ()=>{ if(idx<=0) return; [day.tasks[idx-1], day.tasks[idx]] = [day.tasks[idx], day.tasks[idx-1]]; save(LS_DAYS,days); renderTasks(); });
            const down = document.createElement('button'); down.className='btn small'; down.textContent='↓'; down.addEventListener('click', ()=>{ if(idx>=day.tasks.length-1) return; [day.tasks[idx+1], day.tasks[idx]] = [day.tasks[idx], day.tasks[idx+1]]; save(LS_DAYS,days); renderTasks(); });
            right.appendChild(up); right.appendChild(down);
          }
          const del = document.createElement('button'); del.className='btn secondary small'; del.textContent='Usuń'; del.addEventListener('click', ()=>{ if(confirm('Usuń zadanie?')){ day.tasks = day.tasks.filter(x=>x.id!==t.id); save(LS_DAYS,days); renderTasks(); } });
          right.appendChild(del);
          // dots menu (postpone/edit)
          const dots = document.createElement('button'); dots.className='btn small'; dots.textContent='⋯'; dots.addEventListener('click', ()=>{
            // simple prompt menu (no heavy UI) - postpone or edit
            const action = prompt('Napisz: "o" żeby odłożyć/odłożyć z powrotem, "e" żeby edytować tytuł.'); 
            if(!action) return;
            if(action.toLowerCase().includes('o')){ 
              t.postponed = !t.postponed;
              if(t.postponed) postponed.unshift({id:generateId('pst'), title:t.title, category:t.category, sourceDayId: currentOpenKey, originalId: t.id, originalTask:Object.assign({}, t)});
              else postponed = postponed.filter(p=>!(p.sourceDayId===currentOpenKey && p.originalId===t.id));
              save(LS_POST,postponed);
              save(LS_DAYS,days); renderTasks(); 
            } else if(action.toLowerCase().includes('e')){ const nt = prompt('Nowy tytuł', t.title); if(nt!==null){ t.title = nt.trim(); save(LS_DAYS,days); renderTasks(); } }
          });
          right.appendChild(dots);
        } else {
          // locked/completed view-only: show label if completed
          if(t.completed){
            const done = document.createElement('div'); done.style.fontWeight='700'; done.style.color='var(--muted)'; done.textContent='wykonane'; right.appendChild(done);
          }
        }
        el.appendChild(meta); el.appendChild(right);
        tasksArea.appendChild(el);
      });
      updatePostponedButton();
    }

    function renderPurchases(){ purchasesEl.innerHTML=''; if(!purchases.length) { purchasesEl.innerHTML='<div class="muted">Brak zakupów.</div>'; return; } purchases.forEach(p=>{ const el=document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid rgba(0,0,0,.04)'; el.innerHTML = `<div style="font-weight:700">${escapeHtml(p.name)} <span class="muted">- ${p.price} 🪙</span></div><div class="muted" style="font-size:12px">${p.date}</div>`; purchasesEl.appendChild(el); }); }
    function renderHistory(){ historyEl.innerHTML=''; const all = Object.values(days).sort((a,b)=>b.created - a.created); if(!all.length) historyEl.innerHTML = '<div class="muted">Brak dni</div>'; all.forEach(d=>{ const el=document.createElement('div'); el.style.padding='10px'; el.style.border='1px solid rgba(0,0,0,.04)'; el.style.borderRadius='12px'; el.style.marginBottom='10px'; el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:800">${escapeHtml(d.name||d.date)} <span class="muted">• ${d.date}</span></div><div class="muted" style="margin-top:6px">Zadań: ${(d.tasks||[]).length}</div></div><div><button class="btn small">Otwórz</button></div></div>`; historyEl.appendChild(el); el.querySelector('button').addEventListener('click', ()=>{ currentOpenKey = d.id; snapToIndex(1,true); renderAll(); }); }); }

    function renderAll(){ try{ save(LS_DAYS,days); save(LS_PU, purchases); localStorage.setItem(LS_BAL,balance); save(LS_POST,postponed); renderStats(); renderQuickDays(); renderTasks(); renderPurchases(); renderHistory(); updatePostponedButton(); }catch(e){ console.error(e); } }

    /* ===== EVENTS: create day, add task, lock, finish ===== */
    createNewDayBtn.addEventListener('click', ()=>{
      const date = newDayDate.value || new Date().toISOString().slice(0,10);
      const name = (newDayName.value||'').trim();
      const mode = (newDayMode.value || 'with_time');
      const exist = Object.values(days).find(d=>d.date===date && !d.completed);
      if(exist){ if(!confirm('Dzień z tą datą już istnieje i nie jest zakończony. Utworzyć nowy?')) return; }
      const id = generateId('d');
      days[id] = {id,date,name,mode,tasks:[],locked:false,completed:false,created:Date.now()};
      save(LS_DAYS,days); currentOpenKey = id; snapToIndex(1,true); renderAll();
    });

    taskForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!currentOpenKey) return alert('Wybierz dzień.');
      const title = titleInp.value.trim();
      const category = catInp.value;
      const day = days[currentOpenKey];
      if(!title) return alert('Wypełnij tytuł.');
      if(day.mode === 'with_time'){
        const s = startInp.value; const ed = endInp.value;
        if(!s||!ed) return alert('Wypełnij godziny.');
        day.tasks.push({id:generateId('t'), title, start:s, end:ed, category, completed:false, postponed:false});
      } else {
        day.tasks.push({id:generateId('t'), title, start:'', end:'', category, completed:false, postponed:false});
      }
      save(LS_DAYS,days);
      titleInp.value=''; startInp.value=''; endInp.value='';
      renderTasks();
    });

    lockListBtn.addEventListener('click', ()=>{
      if(!currentOpenKey) return alert('Brak otwartego dnia.');
      const day = days[currentOpenKey];
      if(!confirm('Na pewno zamknąć listę? Po zamknięciu nie będzie możliwości edycji tej listy ani ponownego otwarcia.')) return;
      day.locked = true;
      save(LS_DAYS,days);
      renderTasks();
    });

    finishDayBtn.addEventListener('click', ()=>{
      if(!currentOpenKey) return alert('Brak otwartego dnia.');
      const day = days[currentOpenKey];
      if(day.completed) return alert('Dzień już zakończony.');
      if(!confirm('Zakończyć dzień i rozliczyć monety za wykonane zadania?')) return;
      let gained = 0;
      (day.tasks||[]).forEach(t=>{
        if(t.postponed) return; if(!t.completed) return;
        const rate = ratesPerHour[t.category] || 0;
        if(day.mode === 'with_time'){
          const mins = minutesBetween(t.start,t.end);
          gained += (mins/60) * rate;
        } else gained += rate;
      });
      gained = Math.round(gained);
      balance += gained;
      day.completed = true; day.locked = true;
      save(LS_DAYS,days); localStorage.setItem(LS_BAL,balance); renderAll();
      alert(`Dzień zakończony. Zdobyto +${gained} 🪙.`);
    });

    // postponed modal (simple)
    function renderPostponedModal(){
      const root = document.getElementById('postponedModalRoot');
      root.innerHTML = '';
      if(!postponed.length) return;
      const back = document.createElement('div'); back.style.position='fixed'; back.style.inset='0'; back.style.background='rgba(0,0,0,0.35)'; back.style.display='flex'; back.style.alignItems='center'; back.style.justifyContent='center'; back.style.zIndex='999';
      const modal = document.createElement('div'); modal.style.background='#fff'; modal.style.padding='16px'; modal.style.borderRadius='12px'; modal.style.maxWidth='720px'; modal.style.width='92%';
      modal.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">Odłożone zadania</div><div><button id="closePost" class="btn small">Zamknij</button></div></div><div id="pstList" style="margin-top:12px"></div>`;
      back.appendChild(modal); root.appendChild(back);
      document.getElementById('closePost').addEventListener('click', ()=>{ root.innerHTML=''; });
      const list = modal.querySelector('#pstList');
      postponed.forEach(p=>{
        const item = document.createElement('div'); item.style.display='flex'; item.style.justifyContent='space-between'; item.style.alignItems='center'; item.style.padding='8px'; item.style.borderBottom='1px solid rgba(0,0,0,.04)';
        item.innerHTML = `<div><div style="font-weight:700">${escapeHtml(p.title)}</div><div class="muted" style="font-size:12px">Kategoria: ${escapeHtml(p.category)}</div></div>`;
        const btns = document.createElement('div');
        const restore = document.createElement('button'); restore.className='btn small'; restore.textContent='Przywróć'; restore.addEventListener('click', ()=>{
          if(!currentOpenKey){ alert('Otwórz dzień, do którego chcesz dodać zadanie.'); return; }
          days[currentOpenKey].tasks.push({id:generateId('t'), title:p.title, start:p.originalTask?.start||'', end:p.originalTask?.end||'', category:p.category, completed:false, postponed:false});
          postponed = postponed.filter(x=>x.id!==p.id);
          save(LS_POST,postponed); save(LS_DAYS,days); renderAll(); renderPostponedModal();
        });
        const remove = document.createElement('button'); remove.className='btn small secondary'; remove.textContent='Usuń'; remove.addEventListener('click', ()=>{ if(confirm('Usuń odłożone zadanie?')){ postponed = postponed.filter(x=>x.id!==p.id); save(LS_POST,postponed); renderPostponedModal(); } });
        btns.appendChild(restore); btns.appendChild(remove); item.appendChild(btns); list.appendChild(item);
      });
    }

    if(viewPostponedBtn) viewPostponedBtn.addEventListener('click', ()=>{ renderPostponedModal(); });

    /* ===== INIT ===== */
    // fix small naming bug for save key in renderAll
    function renderAll(){
      try{
        save(LS_DAYS,days);
        save(LS_PUR,purchases);
        localStorage.setItem(LS_BAL,balance);
        save(LS_POST,postponed);
        renderStats(); renderQuickDays(); renderTasks(); renderPurchases(); renderHistory(); updatePostponedButton();
      }catch(e){ console.error(e); }
    }

    // expose for debug
    window.Motywator = {days, balance, purchases, postponed, snapToIndex};

    // start
    snapToIndex(0, false);
    renderAll();

    // persist on unload
    window.addEventListener('beforeunload', ()=>{ save(LS_DAYS,days); save(LS_PUR,purchases); save(LS_POST,postponed); localStorage.setItem(LS_BAL,balance); });

  </script>
</body>
</html>

